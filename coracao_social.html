<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Star ‚òÖ | RFL‚Ä¢‚òÖ‚Ä¢REAL</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCnYzszGEiEkiU9TxwT1ONS2HIEluDHSKM",
            authDomain: "siteloginraphael.firebaseapp.com",
            projectId: "siteloginraphael",
            storageBucket: "siteloginraphael.firebasestorage.app",
            messagingSenderId: "194238150810",
            appId: "1:194238150810:web:8dffbb5f42efd7ea8c0723"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const API_KEY_IMGBB = "SUA_CHAVE_IMGBB_AQUI"; // <-- N√ÉO ESQUE√áA DE COLOCAR SUA CHAVE AQUI

        // --- FUN√á√ïES DE INTERA√á√ÉO (PRECISAM VIR ANTES DO FEED) ---
        function curtirPost(id, curtidasAtuais) {
            db.collection("posts_sociais").doc(id).update({ curtidas: (curtidasAtuais || 0) + 1 });
        }

        function abrirComentarios(postId) {
            const comentario = prompt("RFL‚Ä¢‚òÖ‚Ä¢REAL, o que voc√™ achou desse post?");
            if (comentario && comentario.trim() !== "") {
                db.collection("posts_sociais").doc(postId).update({
                    qtdComentarios: firebase.firestore.FieldValue.increment(1)
                }).then(() => { alert("Coment√°rio registrado!"); });
            }
        }

        function compartilharPost() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert("Link da Social Star ‚òÖ copiado!");
            });
        }

        function excluirPost(id) {
            if (confirm("RFL‚Ä¢‚òÖ‚Ä¢REAL, deseja excluir este post?")) {
                db.collection("posts_sociais").doc(id).delete();
            }
        }

        async function verPerfil(emailAutor) {
            const nome = emailAutor.split('@')[0];
            alert(`‚≠ê PERFIL SOCIAL STAR ‚òÖ\n\nUsu√°rio: @${nome}\nMembro Oficial.`);
        }

        // --- PUBLICAR ---
       async function publicarPost() {
    const campoTexto = document.getElementById('post-texto');
    const campoFoto = document.getElementById('post-foto');
    const texto = campoTexto.value;
    const fotoArquivo = campoFoto.files[0];
    const user = auth.currentUser;

    // 1. Verifica√ß√£o de Usu√°rio
    if (!user) { 
        alert("Voc√™ precisa estar logado!"); 
        return; 
    }

    // 2. Valida√ß√£o de Conte√∫do Vazio
    if (texto.trim() === "" && !fotoArquivo) {
        alert("RFL‚Ä¢‚òÖ‚Ä¢REAL, escreva algo ou selecione uma foto!");
        return;
    }

    try {
        // 3. Busca Segura da Foto de Perfil
        const userDoc = await db.collection("usuarios").doc(user.uid).get();
        let fotoPerfilAutor = "";
        
        if (userDoc.exists && userDoc.data().fotoPerfil) {
            fotoPerfilAutor = userDoc.data().fotoPerfil;
        }

        // 4. Upload para o ImgBB (Se houver foto no post)
        let urlFotoPost = "";
        if (fotoArquivo) {
            const formData = new FormData();
            formData.append("image", fotoArquivo);

            const response = await fetch("https://api.imgbb.com/1/upload?key=ede86576a675116955921d850f5cd7e3", {
                method: "POST",
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                urlFotoPost = data.data.url; 
            } else {
                throw new Error("Falha no upload da imagem. Verifique a chave ImgBB.");
            }
        }

        // 5. Grava√ß√£o no Firebase Firestore
        await db.collection("posts_sociais").add({
            autor: user.email,
            autorFoto: fotoPerfilAutor, 
            mensagem: texto,
            fotoUrl: urlFotoPost, 
            curtidas: 0,
            qtdComentarios: 0,
            data: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 6. Limpeza e Sucesso
        campoTexto.value = "";
        campoFoto.value = "";
        alert("‚≠ê Publicado com sucesso!");

        // 7. Atualizar Feed (Opcional: se voc√™ tiver essa fun√ß√£o)
        if (typeof carregarFeed === "function") carregarFeed();

    } catch (error) {
        console.error("Erro detalhado:", error);
        alert("Erro ao publicar: " + error.message);
    }
}      // --- CARREGAR FEED ---
       function carregarFeed() {
    db.collection("posts_sociais").orderBy("data", "desc")
    .onSnapshot((snapshot) => {
        const feedContainer = document.getElementById('feed');
        feedContainer.innerHTML = ""; 
        const autoresUnicos = new Set();

        snapshot.forEach((doc) => {
            const post = doc.data();
            const id = doc.id;
            autoresUnicos.add(post.autor);
            const nomeUsuario = post.autor ? post.autor.split('@')[0] : "Membro";
            const eDono = auth.currentUser && auth.currentUser.email === post.autor;

            // Foto padr√£o caso o usu√°rio n√£o tenha foto ainda
            const fotoPadrao = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

            feedContainer.innerHTML += `
                <div class="feed-item" style="background:#1a1a1a; padding:20px; border-radius:15px; margin-bottom:15px; border:1px solid #333;">
                    
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <img src="${post.autorFoto || fotoPadrao}" 
                             style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #00f2ea;">
                        <h4 onclick="verPerfil('${post.autor}')" style="cursor:pointer; color:#00f2ea;">@${nomeUsuario}</h4>
                    </div>

                    <p style="margin-bottom: 12px; line-height: 1.4; color: white;">${post.mensagem || ""}</p>
                    
                    ${post.fotoUrl ? `<img src="${post.fotoUrl}" alt="Post de RFL‚Ä¢‚òÖ‚Ä¢REAL">` : ''}
                    
                    <div style="margin-top:15px; display:flex; gap:25px; font-size: 1rem; border-top: 1px solid #222; padding-top: 12px;">
                        <span style="cursor:pointer; display: flex; align-items: center; gap: 5px;" onclick="curtirPost('${id}', ${post.curtidas || 0})">
                            ‚ù§Ô∏è <b style="color: white;">${post.curtidas || 0}</b>
                        </span>
                        <span style="cursor:pointer; color:#00f2ea; display: flex; align-items: center; gap: 5px;" onclick="abrirComentarios('${id}')">
                            üí¨ <b style="color: white;">${post.qtdComentarios || 0}</b>
                        </span>
                        <span style="cursor:pointer; color:#ffd700; display: flex; align-items: center; gap: 5px;" onclick="compartilharPost()">
                            üîó <b style="color: white;">Link</b>
                        </span>
                        ${eDono ? `<span style="cursor:pointer; color:#ff4d6d; margin-left: auto;" onclick="excluirPost('${id}')">üóëÔ∏è</span>` : ''}
                    </div>
                </div>`;
        });
        
        const painelMembros = document.getElementById('membros-count');
        if (painelMembros) painelMembros.innerText = autoresUnicos.size + " Membros ativos";
    });
}

        // --- AUTH ---
       auth.onAuthStateChanged((user) => {
    if (user) {
       
        db.collection("usuarios").doc(user.uid).set({
            email: user.email,
            nome: user.email.split('@')[0],
           
            desde: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

       
        carregarFeed();             // Carrega os posts
        atualizarContagemMembros();  // <--- NOVA FUN√á√ÉO ADICIONADA AQUI
        
    } else {
        // Se n√£o estiver logado, volta para a tela de abertura
        window.location.href = "abertura.html";
    }
});

        function realizarLogout() {
            auth.signOut().then(() => { window.location.href = "abertura.html"; });
        }
        async function mudarFotoPerfil() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = async (e) => {
        const foto = e.target.files[0];
        const user = auth.currentUser;
        
        if (!foto || !user) return;

        try {
            const formData = new FormData();
            formData.append("image", foto);
            
            // Faz o upload para o ImgBB
            const response = await fetch("https://api.imgbb.com/1/upload?key=ede86576a675116955921d850f5cd7e3", {
    method: "POST",
    body: formData
});
            const data = await response.json();
            
            if (data.success) {
                // Salva a URL da foto no documento do usu√°rio
                await db.collection("usuarios").doc(user.uid).update({
                    fotoPerfil: data.data.url
                });
                alert("Foto de perfil atualizada com sucesso!");
            }
        } catch (error) {
            console.error("Erro ao mudar foto:", error);
            alert("Erro ao carregar a foto.");
        }
    };
    input.click();
}
     function atualizarContagemMembros() {
    db.collection("usuarios").get().then((snapshot) => {
        const total = snapshot.size; 
        const painelMembros = document.getElementById('membros-count');
        if (painelMembros) {
            painelMembros.innerText = total + (total === 1 ? " Membro cadastrado" : " Membros cadastrados");
        }
    }).catch(erro => console.error("Erro ao contar:", erro));
}
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #121212; color: white; display: grid; grid-template-columns: 250px 1fr 300px; height: 100vh; }
        nav { background-color: #1a1a1a; border-right: 1px solid #333; padding: 20px; }
        nav h2 { color: #ff0050; margin-bottom: 30px; font-size: 1.5rem; }
        nav ul { list-style: none; }
        nav ul li { padding: 15px 10px; border-radius: 8px; cursor: pointer; transition: 0.3s; margin-bottom: 5px; }
        nav ul li:hover { background-color: #333; color: #00f2ea; }
        main { overflow-y: auto; padding: 20px; background-color: #000; }
        .post-input { background: #1a1a1a; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #333; }
        .post-input textarea { width: 100%; background: transparent; border: none; color: white; font-size: 1.1rem; resize: none; outline: none; min-height: 80px; }
        .btn-post { background: linear-gradient(45deg, #ff0050, #00f2ea); border: none; padding: 10px 25px; color: white; border-radius: 20px; font-weight: bold; float: right; cursor: pointer; }
        .feed-item { background: #1a1a1a; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; }
        aside { background-color: #1a1a1a; border-left: 1px solid #333; padding: 20px; }
        .trending-box { background: #252525; padding: 15px; border-radius: 10px; }
        .tag { color: #ff0050; display: block; margin-bottom: 10px; text-decoration: none; font-weight: bold; }
        /* Configura√ß√£o para as fotos postadas no Feed */
.feed-item img {
    width: 100%;            /* Ocupa toda a largura do post no celular */
    max-width: 600px;       /* No PC, ela n√£o vai passar de 600px (tamanho elegante) */
    height: auto;           /* Mant√©m a propor√ß√£o da foto sem achatar */
    max-height: 500px;      /* Impede que fotos muito altas (verticais) empurrem o feed demais */
    display: block;         /* Remove espa√ßos extras abaixo da imagem */
    margin: 15px auto;      /* Centraliza a foto e d√° um espa√ßo do texto */
    border-radius: 12px;    /* Arredonda as bordas para combinar com seu layout */
    object-fit: contain;    /* Garante que a imagem inteira apare√ßa sem cortes */
    background: #000;       /* Se a foto for menor que o espa√ßo, o fundo fica preto */
    border: 1px solid #333; /* Uma borda sutil para separar do fundo */
}
    </style>
</head>
<body>
    <nav>
    <h2>Social Star ‚òÖ</h2>
    <ul>
        <li>üè† In√≠cio</li>
        <li>üîç Explorar</li>
        <li>üîî Notifica√ß√µes</li>
        <li onclick="mudarFotoPerfil()" style="color: #00f2ea; font-weight: bold;">üì∏ Mudar Foto</li>
        <li onclick="alert('Perfil em desenvolvimento!')">üë§ Perfil</li>
        <li style="color: #ff4d6d; margin-top: 20px;" onclick="realizarLogout()">üö™ Sair</li>
    </ul>
</nav>
    <main>
        <div class="post-input">
            <textarea id="post-texto" placeholder="O que est√° acontecendo?"></textarea>
            <input type="file" id="post-foto" accept="image/*" style="margin-top: 10px; color: #888;">
            <button class="btn-post" onclick="publicarPost()">Publicar</button>
            <div style="clear: both;"></div>
        </div>
        <div id="feed"></div>
 
    <aside>
        <div class="trending-box">
            <h3>Comunidade</h3>
            <p id="membros-count" style="color: #00f2ea; font-weight: bold; margin-bottom: 15px;">Calculando...</p>
            <hr style="border: 0.1px solid #333; margin-bottom: 15px;">
            <h3>Tend√™ncias</h3>
            <a href="#" class="tag">#RFL_REAL</a>
            <a href="#" class="tag">#SocialStar2026</a>
        </div>
    </aside>
        <div id="btn-abrir-chat" onclick="toggleChat()">
        üí¨ ChatGlobal/ChatFamily
    </div>

    <div id="janela-chat" style="display: none;">
        <div class="chat-header">
            <span>ChatGlobal/ChatFamily</span>
            <button onclick="toggleChat()" style="background:none; border:none; color:white; cursor:pointer;">‚úñ</button>
        </div>
        <div id="mensagens-chat"></div>
        <div class="chat-input-area">
            <input type="text" id="input-msg-chat" placeholder="Digite uma mensagem..." onkeypress="if(event.key === 'Enter') enviarMensagemChat()">
            <button onclick="enviarMensagemChat()">üöÄ</button>
        </div>
    </div>

</body>
</html>

